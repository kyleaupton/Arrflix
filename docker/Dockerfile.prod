FROM golang:1.25.5 AS backend-build
WORKDIR /src
COPY . .
RUN cd backend && go build -o /out/backend ./cmd/api

FROM node:22 AS web-build
WORKDIR /src
COPY . .
RUN cd web && npm ci && npm run build-only

FROM ubuntu:24.04

ARG S6_VERSION=3.2.1.0
ARG PROWLARR_VERSION=2.3.0.5236
ARG PROWLARR_ARCH=linux-core-x64
ARG ARRFLIX_VERSION=""
ARG ARRFLIX_COMMIT=""
ARG ARRFLIX_BUILD_DATE=""

# Install xz-utils first, then runtime dependencies
RUN apt-get update && apt-get install -y \
    xz-utils \
    postgresql \
    postgresql-client \
    nginx \
    ca-certificates \
    curl \
    mediainfo && \
    rm -rf /var/lib/apt/lists/*

# Install s6-overlay
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_VERSION}/s6-overlay-noarch.tar.xz /tmp/
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_VERSION}/s6-overlay-x86_64.tar.xz /tmp/
RUN cd / && \
    tar -Jxpf /tmp/s6-overlay-noarch.tar.xz && \
    tar -Jxpf /tmp/s6-overlay-x86_64.tar.xz && \
    rm /tmp/*.tar.xz

# Install Prowlarr
RUN set -eux; \
    mkdir -p /opt/prowlarr && cd /opt/prowlarr && \
    curl -fsSL https://github.com/Prowlarr/Prowlarr/releases/download/v${PROWLARR_VERSION}/Prowlarr.master.${PROWLARR_VERSION}.${PROWLARR_ARCH}.tar.gz -o prowlarr.tar.gz && \
    tar -xzf prowlarr.tar.gz --strip-components=1 && \
    rm prowlarr.tar.gz && \
    ln -sf /opt/prowlarr/Prowlarr /usr/local/bin/prowlarr

# Copy app artifacts
COPY --from=backend-build /out/backend /opt/app/backend
COPY --from=web-build /src/web/dist /usr/share/nginx/html

# Copy s6 services
COPY docker/s6 /etc/s6-overlay

ENV APP_ENV=prod
ENV PATH="/command:$PATH"
ENV ARRFLIX_VERSION=${ARRFLIX_VERSION}
ENV ARRFLIX_COMMIT=${ARRFLIX_COMMIT}
ENV ARRFLIX_BUILD_DATE=${ARRFLIX_BUILD_DATE}
ENV PROWLARR_VERSION=${PROWLARR_VERSION}
ENTRYPOINT ["/init"]