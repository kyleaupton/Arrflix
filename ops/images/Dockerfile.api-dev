FROM golang:1.24

# Install Air for live reload
RUN curl -fsSL https://raw.githubusercontent.com/cosmtrek/air/master/install.sh | bash -s -- -b /usr/local/bin

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

WORKDIR /app/backend

# Copy go mod files
COPY backend/go.mod backend/go.sum ./
RUN go mod download

# Copy source code
COPY backend ./

# Set up Air config
RUN echo '[build]\n  cmd = "go build -o /tmp/api ./cmd/api"\n  bin = "/tmp/api"\n  include_ext = ["go", "tpl", "tmpl", "html"]\n  exclude_dir = ["assets", "tmp", "vendor", "testdata"]\n  exclude_file = []\n  exclude_regex = ["_test.go"]\n  exclude_unchanged = false\n  follow_symlink = false\n  full_bin = ""\n  include_dir = []\n  kill_delay = "0s"\n  log = "build-errors.log"\n  poll = false\n  poll_interval = 0\n  rerun = false\n  rerun_delay = 500\n  send_interrupt = false\n  stop_on_root = false\n\n[color]\n  app = ""\n  build = "yellow"\n  main = "magenta"\n  runner = "green"\n  watcher = "cyan"\n\n[log]\n  main_only = false\n  time = false\n\n[misc]\n  clean_on_exit = false\n\n[screen]\n  clear_on_rebuild = false\n  keep_scroll = true' > .air.toml

ENTRYPOINT ["air"]
