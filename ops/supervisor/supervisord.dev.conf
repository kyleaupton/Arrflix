[supervisord]
nodaemon=true
logfile=/dev/null
pidfile=/var/run/supervisord.pid

; Order via priorities: lower starts first.
[program:postgres]
command=/usr/local/bin/run-postgres.sh
; Uses env vars like POSTGRES_DB/USER/PASSWORD/PGDATA
priority=10
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
environment=PGDATA="/var/lib/postgresql/data"
user=postgres

[program:prowlarr]
command=/bin/sh -c "/usr/local/bin/wait-for-db.sh && /usr/local/bin/start-prowlarr-with-apikey.sh"
directory=/opt/prowlarr
priority=20
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:api-dev]
; Wait for DB and Prowlarr, export PROWLARR_API_KEY, then run Go API with live reload
command=/bin/sh -c "/usr/local/bin/wait-for-db.sh && /usr/local/bin/wait-for-prowlarr.sh && export PROWLARR_API_KEY=$(/usr/local/bin/get-prowlarr-apikey.sh) && cd /app/backend && PATH=/usr/local/go/bin:$PATH exec air"
directory=/app/backend
priority=30
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
environment=PORT="8080",PATH="/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

[program:vite]
; Start Vite dev server and allow HMR websockets
; Install deps if vite binary is missing (handles empty/new node_modules volume)
command=/bin/sh -c "cd /web && ([ -x node_modules/.bin/vite ] || npm ci) && npm run dev -- --host 0.0.0.0 --port 5173"
directory=/web
priority=40
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:nginx]
command=nginx -g "daemon off;"
priority=50
autorestart=true
startretries=10
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0



